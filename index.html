<!doctype html>
<html lang="en-us">
  <head>
    
  </head>
  <body>
    
    <canvas id="canvas" width="800" height="800"></canvas>
    <script async type="text/javascript" src="mandelbrot.js"></script>
    <table style="border-spacing: 3em 0; border-collapse: separate;">
      <tbody>
        <tr>
          <td>
            <div id="zoomWidget">
              <table>
                <tbody>
                  <tr>
                    <td>Zoom</td>
                  </tr>
                  <tr>
                    <td><button id="zoom in">+</button></td>
                  </tr>
                  <tr>
                    <td><button id="zoom out">-</button></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </td>
          <td>
            <div id="directionsControl">
              <table>
                <tbody>
                  <tr><td></td><td>Move</td><td></td></tr>
                  <tr><td></td><td><button id="up">up</button></td><td></td></tr>
                  <tr><td><button id="left">left</button></td><td><button id="initbutton">init</button></td><td><button id="right">right</button></td></tr>
                  <tr><td></td><td><button id="down">down</button></td><td></td></tr>
                  
                </tbody>
              </table>
            </div>
          </td>
          <td>
            <div>
            <table>
              <tbody>
                <tr><td id="x1"></td></tr>
                <tr><td id="x2"></td></tr>
                <tr><td id="y1"></td></tr>
                <tr><td id="y2"></td></tr>
              </tbody>
            </table>
            </div>
          </td>
        <tr>
      </tbody>
    </table>
    
    
    
    <script>
      const width = 700;
      const height = 700;
      let x1 = -1.5;
      let x2 = 0.5;
      let y1 = -1.0;
      let y2 = -1.0;
      // let x1 = 0.3;
      // let x2 = 0.5;
      // let y1 = -0.3;
      // let y2 = -0.5;
      let minZoom = 0.01;

      const updateMinZoom = () => {
        if (Math.abs(x2 - x1) < 20 * minZoom || Math.abs(y2 - y1) < 20 * minZoom) {
          minZoom = minZoom / 10;
        }
      }

      const setBounds = () => {
        document.getElementById("x1").innerHTML = "x1: " + x1;
        document.getElementById("x2").innerHTML = "x2: " + x2;
        document.getElementById("y1").innerHTML = "y1: " + y1;
        document.getElementById("y2").innerHTML = "y2: " + y2;
        updateMinZoom();
      }
      
      const getDefaultImage = () => {
        let def =[];
        for(let i = 0;i < width; i++) {
          for(let j = 0;j < height; j++) {
            for(let k = 0;k < 3; k++) {
              def.push(0);
            }
          } 
        }
        return def;
      }
      const getImage = () => {
        console.log(x1, x2, y1, y2)
        const numEle = width * height * 4;
        const result = Module.ccall('getMandelbrotImagePixels','number', ['number', 'number', 'number', 'number', 'number', 'number'], [width, height, x1, x2, y1, y2]);
        const arrayData = []
        const offset = result/Uint32Array.BYTES_PER_ELEMENT;
        for (let v=0; v < numEle; v++) {
            arrayData.push( Module.HEAPF64[result/Float64Array.BYTES_PER_ELEMENT+v] )
        }

        // let pixels = arrayData.reduce((rows, key, index) => (index % 4 == 0 ? rows.push([key]) : rows[rows.length-1].push(key)) && rows, []);
        return arrayData;
      }

      function initializeCanvas(img) {
        canvas = document.getElementById('canvas');
        context = canvas.getContext('2d');
        if (canvas) {
          let ctx = canvas.getContext("2d");
          

          var imgData = ctx.createImageData(width, height); // width x height
          var data = imgData.data;

          data.set(new Uint8ClampedArray(img));

          ctx.putImageData(imgData, 0, 0);
        }
      }
      
      document.getElementById("initbutton").addEventListener("click", () => {
        x1 = -1.5;
        x2 = 0.5;
        y1 = -1.0;
        y2 = 1.0;
        // x1 = 0.3;
        // x2 = 0.5;
        // y1 = -0.3;
        // y2 = -0.5;
        img2 = getImage();
        // let img = getDefaultImage();
        initializeCanvas(img2);
        setBounds();
      });

      document.getElementById("zoom in").addEventListener("click", () => {
        x1 = x1 + minZoom
        x2 = x2 - minZoom
        y1 = y1 + minZoom
        y2 = y2 - minZoom
        let img2 = getImage();
        // let img = getDefaultImage();
        initializeCanvas(img2);
        setBounds();
      });

      document.getElementById("zoom out").addEventListener("click", () => {
        x1 = x1 - minZoom
        x2 = x2 + minZoom
        y1 = y1 - minZoom
        y2 = y2 + minZoom
        if (x1 < -2.0) x1 = -2.0;
        if (y1 < -2.0) y1 = -2.0;
        if (x2 > 2.0) x2 = 2.0;
        if (y2 > 2.0) y2 = 2.0;
        let img2 = getImage();
        // let img = getDefaultImage();
        initializeCanvas(img2);
        setBounds();
      });

      document.getElementById("up").addEventListener("click", () => {
        y1 = y1 + minZoom
        y2 = y2 + minZoom
        if (y1 < -2.0) y1 = -2.0;
        if (y2 > 2.0) y2 = 2.0;
        let img2 = getImage();
        // let img = getDefaultImage();
        initializeCanvas(img2);
        setBounds();
      });

      document.getElementById("down").addEventListener("click", () => {
        y1 = y1 - minZoom
        y2 = y2 - minZoom
        if (y1 < -2.0) y1 = -2.0;
        if (y2 > 2.0) y2 = 2.0;
        let img2 = getImage();
        // let img = getDefaultImage();
        initializeCanvas(img2);
        setBounds();
      });

      document.getElementById("left").addEventListener("click", () => {
        x1 = x1 - minZoom
        x2 = x2 - minZoom
        if (x1 < -2.0) x1 = -2.0;
        if (x2 > 2.0) x2 = 2.0;
        let img2 = getImage();
        // let img = getDefaultImage();
        initializeCanvas(img2);
        setBounds();
      });

      document.getElementById("right").addEventListener("click", () => {
        x1 = x1 + minZoom
        x2 = x2 + minZoom
        if (x1 < -2.0) x1 = -2.0;
        if (x2 > 2.0) x2 = 2.0;
        let img2 = getImage();
        // let img = getDefaultImage();
        initializeCanvas(img2);
        setBounds();
      });
    </script>
    <p>Please Click on the "init" button to start or reinitialize the canvas. Keep zooming in to infinity!<p>
  </body>
</html>
